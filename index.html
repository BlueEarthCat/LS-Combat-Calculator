<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>전투력 계산기</title>

  <!-- 배포 시: Tailwind/Fonts를 로컬로 번들해 CSP 강화 권장 -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    /* ==== 기존 스타일 유지 (원문 그대로) ==== */
    body{font-family:'Noto Sans KR',sans-serif;background-color:#1f2937;color:#e5e7eb;margin:0;padding:16px}
    .container{max-width:850px;margin:auto;background-color:#374151;border-radius:10px;padding:20px;box-shadow:0 8px 16px rgba(0,0,0,.3)}
    h2{font-size:1.8rem;font-weight:700;text-align:center;color:#60a5fa;margin-bottom:1.2rem}
    h3{font-size:1.1rem;font-weight:500;color:#93c5fd;margin:.8rem 0}
    .stats-container{display:flex;gap:10px;margin-bottom:20px}
    .stat-group{flex:1;background-color:#4b5563;border-radius:6px;padding:10px;box-shadow:0 3px 5px rgba(0,0,0,.2)}
    .stat-group h4{font-size:1rem;font-weight:500;text-align:center;color:#bfdbfe;margin-bottom:8px}
    .input-area{max-height:350px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#60a5fa #4b5563}
    .input-area::-webkit-scrollbar{width:5px}
    .input-area::-webkit-scrollbar-thumb{background-color:#60a5fa;border-radius:3px}
    .input-area::-webkit-scrollbar-track{background-color:#4b5563}
    .skill-area{max-height:220px;overflow-y:auto;background-color:#4b5563;border-radius:6px;padding:10px;margin-bottom:12px;box-shadow:0 3px 5px rgba(0,0,0,.2);scrollbar-width:thin;scrollbar-color:#60a5fa #4b5563;display:flex;gap:10px}
    .skill-area::-webkit-scrollbar{width:5px}
    .skill-area::-webkit-scrollbar-thumb{background-color:#60a5fa;border-radius:3px}
    .skill-area::-webkit-scrollbar-track{background-color:#4b5563}
    .skill-column{flex:1;display:flex;flex-direction:column;gap:4px}
    .blessing-area{display:flex;justify-content:space-between;gap:10px;margin-bottom:20px}
    .blessing-button{width:70px;height:70px;border-radius:6px;cursor:pointer;transition:transform .2s,box-shadow .2s;position:relative;border:2px solid transparent}
    .blessing-button:hover{transform:scale(1.05);box-shadow:0 3px 6px rgba(0,0,0,.3)}
    .blessing-button[data-state="on"]{border-color:#60a5fa}
    .blessing-button::after{content:attr(data-tooltip);position:absolute;bottom:-28px;left:50%;transform:translateX(-50%);background-color:#1f2937;color:#e5e7eb;padding:3px 6px;border-radius:3px;font-size:11px;white-space:nowrap;opacity:0;transition:opacity .2s;pointer-events:none}
    .blessing-button:hover::after{opacity:1}
    .stat-row,.skill-row{display:flex;align-items:center;margin-bottom:6px;gap:4px}
    .stat-label,.skill-label{flex:3;text-align:left;font-size:12px;color:#d1d5db;padding-right:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;word-break:break-all}
    .stat-input,.skill-input,.skill-select{flex:1;padding:4px;border:1px solid #6b7280;border-radius:4px;background-color:#1f2937;color:#e5e7eb;font-size:12px;max-width:80px;transition:border-color .2s}
    .stat-input:focus,.skill-input:focus,.skill-select:focus{outline:none;border-color:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,.3)}
    .skill-select{flex:3;max-width:150px}
    .skill-input{flex:1;max-width:60px}
    .skill-input:disabled{background-color:#4b5563;cursor:not-allowed}
    .button-container{display:flex;gap:10px;margin-bottom:12px}
    button{padding:10px;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;transition:background-color .2s,transform .2s;border:none}
    button.calculate{background-color:#2563eb}
    button.calculate:hover{background-color:#1d4ed8;transform:translateY(-2px)}
    button.reset{background-color:#dc2626}
    button.reset:hover{background-color:#b91c1c;transform:translateY(-2px)}
    #result{font-size:1.3rem;font-weight:700;text-align:center;color:#60a5fa;background-color:#1f2937;padding:12px;border-radius:6px;box-shadow:0 3px 5px rgba(0,0,0,.2);animation:fadeIn .5s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    @media (max-width:768px){
      .stats-container{flex-direction:column}
      .stat-group{width:100%}
      .blessing-area{flex-wrap:wrap;justify-content:center}
      .blessing-button{width:50px;height:50px}
      .stat-label,.skill-label{font-size:11px}
      .stat-input,.skill-input,.skill-select{font-size:11px;padding:3px;max-width:70px}
      .skill-select{max-width:120px}
      .skill-input{max-width:50px}
      .skill-area{flex-direction:column}
      .skill-column{width:100%}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>전투력 계산기</h2>

    <h3>축복 선택</h3>
    <div class="blessing-area" id="blessingArea" role="group" aria-label="축복 선택"></div>

    <h3>스탯 입력</h3>
    <div class="stats-container">
      <div class="stat-group" id="group1">
        <h4>공격 관련</h4>
        <div class="input-area" id="inputArea1"></div>
      </div>
      <div class="stat-group" id="group2">
        <h4>방어 관련</h4>
        <div class="input-area" id="inputArea2"></div>
      </div>
      <div class="stat-group" id="group3">
        <h4>기타</h4>
        <div class="input-area" id="inputArea3"></div>
      </div>
    </div>

    <h3>스킬 입력</h3>
    <div class="skill-area" id="skillArea">
      <div class="skill-column" id="skillColumn1"></div>
      <div class="skill-column" id="skillColumn2"></div>
    </div>

    <div class="button-container">
      <!-- 인라인 핸들러 제거, type 지정 -->
      <button id="btnCalc" class="calculate" type="button">계산하기</button>
      <button id="btnReset" class="reset" type="button">초기화</button>
    </div>

    <div id="result" aria-live="polite">전투력: 0</div>
  </div>

  <script>
    // ===== 데이터 =====
    const stats = [
      { name: '공격력', weight: 25 }, { name: '적중', weight: 200 },
      { name: '치명타 확률', weight: 100 }, { name: '치명타 피해량', weight: 50 },
      { name: '기본공격 쿨타임', weight: 150 }, { name: '스킬 쿨타임', weight: 300 },
      { name: '모든 피해량', weight: 250 }, { name: '기본공격 피해량', weight: 100 },
      { name: '스킬 피해량', weight: 200 }, { name: '모든 몬스터 피해량', weight: 200 },
      { name: '일반 몬스터 피해량', weight: 15 }, { name: '영웅 몬스터 피해량', weight: 15 },
      { name: '플레이어 피해량', weight: 100 }, { name: '상태이상 적중', weight: 40 },
      { name: '방어력 상쇄', weight: 15 }, { name: '회피 상쇄', weight: 150 },
      { name: '방어력', weight: 15 }, { name: '회피', weight: 150 },
      { name: '받는 모든 피감', weight: 250 }, { name: '받는 기본공격 피감', weight: 100 },
      { name: '받는 스킬 피감', weight: 200 }, { name: '받는 몬스터 피감', weight: 100 },
      { name: '받는 플레이어 피감', weight: 100 }, { name: '공격력 저항', weight: 25 },
      { name: '적중 저항', weight: 200 }, { name: '치명타 확률 저항', weight: 100 },
      { name: '치명타 피해량 저항', weight: 50 }, { name: '기절 저항', weight: 80 },
      { name: '기절 지속 감소', weight: 40 }, { name: '상태이상 저항', weight: 40 },
      { name: '상태 지속 감소', weight: 20 }, { name: '최대 HP', weight: 1 },
      { name: '이동속도', weight: 15 }, { name: 'HP 자연 회복량', weight: 25 },
      { name: '물약 회복량', weight: 25 }, { name: '경험치 획득량', weight: 5 },
      { name: '골드 획득량', weight: 5 }, { name: '드랍율', weight: 5 },
      { name: '스킬 치유량 증가', weight: 50 }, { name: '스킬 보호막 증가', weight: 50 },
      { name: '버프 지속시간 증가', weight: 25 }
    ];

    const blessings = [
      { name: '용사의 축복', effects: { '공격력': 30, '적중': 3, '방어력': 30, '회피': 3, '최대 HP': 500 }, combatPower: 0, type: 'blessing1'},
      { name: '현자의 축복', effects: { '경험치 획득량': 30 }, combatPower: 0, type: 'blessing2' },
      { name: '생활의 축복', effects: { '이동속도': 10 }, combatPower: 0, type: 'blessing3' },
      { name: '용병의 축복', effects: {}, combatPower: 0, type: 'blessing4' }
    ];

    const skillValues = {
      normal:[300,309,318,328,361,372,383,394,405,450,458,467,476,486,525,536,547,564,581,600],
      advanced:[500,515,530,546,601,619,637,656,676,750,765,781,796,812,877,895,913,941,969,1000],
      rare:[1000,1030,1060,1092,1202,1238,1276,1315,1354,1500,1530,1561,1593,1626,1756,1791,1828,1883,1939,2000],
      heroic:[2000,2060,2120,2184,2404,2476,2552,2630,2708,3000,3060,3122,3186,3252,3512,3582,3656,3766,3878,4000],
      none:Array(20).fill(0)
    };

    const availableSkills = [
      { name:'해제',type:'none' },
      { name:'일반 스킬 1',type:'normal' },{ name:'일반 스킬 2',type:'normal' },{ name:'일반 스킬 3',type:'normal' },
      { name:'고급 스킬 1',type:'advanced' },{ name:'고급 스킬 2',type:'advanced' },{ name:'고급 스킬 3',type:'advanced' },
      { name:'희귀 스킬 1',type:'rare' },{ name:'희귀 스킬 2',type:'rare' },{ name:'희귀 스킬 3',type:'rare' },
      { name:'영웅 스킬 1',type:'heroic' },{ name:'영웅 스킬 2',type:'heroic' }
    ];

    // ===== 엘리먼트 참조 =====
    const inputArea1 = document.getElementById('inputArea1');
    const inputArea2 = document.getElementById('inputArea2');
    const inputArea3 = document.getElementById('inputArea3');
    const blessingArea = document.getElementById('blessingArea');
    const skillColumn1 = document.getElementById('skillColumn1');
    const skillColumn2 = document.getElementById('skillColumn2');
    const btnCalc = document.getElementById('btnCalc');
    const btnReset = document.getElementById('btnReset');
    const resultEl = document.getElementById('result');

    const statInputs = [];
    const skillSelects = [];
    const skillLevelInputs = []; // { input, type?, name?, select? }
    const blessingButtons = [];

    // ===== 축복 버튼 생성 (접근성 향상) =====
    blessings.forEach((blessing) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'blessing-button';
      btn.setAttribute('role','button');
      btn.setAttribute('aria-pressed','false');
      btn.dataset.state = 'off';
      btn.dataset.name = blessing.name;
      btn.dataset.type = blessing.type; // 파일명 생성을 위해 고정 사용
      btn.dataset.tooltip = blessing.name;
      btn.title = blessing.name;

      // 이미지 자식
      const img = document.createElement('img');
      img.src = `images/${blessing.type}_off.png`;
      img.alt = blessing.name;
      img.width = 70; img.height = 70;
      btn.appendChild(img);

      // 토글
      btn.addEventListener('click', () => {
        const on = btn.dataset.state === 'off';
        btn.dataset.state = on ? 'on' : 'off';
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
        img.src = `images/${btn.dataset.type}_${btn.dataset.state}.png`;
        void calculateCombatPower(); // 저장 X
      });

      blessingArea.appendChild(btn);
      blessingButtons.push(btn);
    });

    // ===== 스탯 입력 생성 =====
    function addStatRow(area, stat, idx){
      const row = document.createElement('div');
      row.className = 'stat-row';
      const label = document.createElement('label');
      label.className = 'stat-label';
      label.textContent = stat.name;
      row.appendChild(label);

      const input = document.createElement('input');
      input.type = 'number'; input.min = '0'; input.step = 'any';
      input.value = '0'; input.className = 'stat-input';
      input.addEventListener('input', () => calculateCombatPower());
      row.appendChild(input);

      statInputs[idx] = input;
      area.appendChild(row);
    }

    stats.slice(0,16).forEach((st, i)=> addStatRow(inputArea1, st, i));
    stats.slice(16,31).forEach((st, i)=> addStatRow(inputArea2, st, 16+i));
    stats.slice(31).forEach((st, i)=> addStatRow(inputArea3, st, 31+i));

    // ===== 고정 스킬 (기본공격, 이동기) =====
    const fixedSkills = [{ name:'기본공격', type:'advanced' }, { name:'이동기', type:'advanced' }];

    fixedSkills.forEach((skill, index) => {
      const row = document.createElement('div'); row.className = 'skill-row';
      const label = document.createElement('label'); label.className = 'skill-label'; label.textContent = skill.name;
      const input = document.createElement('input');
      input.type='number'; input.min='1'; input.max='20'; input.value='1'; input.className='skill-input';
      input.addEventListener('input', () => calculateCombatPower());
      row.appendChild(label); row.appendChild(input);
      skillLevelInputs.push({ input, type: skill.type, name: skill.name });
      (index===0 ? skillColumn1 : skillColumn2).appendChild(row);
    });

    // ===== 선택 스킬 8개 =====
    for (let i=0;i<4;i++){
      const mkRow = (slotIdx, parentCol) => {
        const row = document.createElement('div'); row.className='skill-row';
        const label = document.createElement('label'); label.className='skill-label'; label.textContent = `스킬${slotIdx}`;
        const select = document.createElement('select'); select.className='skill-select';
        availableSkills.forEach(sk => {
          const opt = document.createElement('option');
          opt.value = `${sk.type}|${sk.name}`; opt.textContent = sk.name; select.appendChild(opt);
        });
        select.value = 'none|해제';

        const input = document.createElement('input');
        input.type='number'; input.min='1'; input.max='20'; input.value='1';
        input.className='skill-input'; input.disabled=true;

        // 중복 방지: 현재 select 기준으로만 검사해 즉시 롤백
        const handleChange = () => {
          const [type, name] = select.value.split('|');
          if (name === '해제'){ input.disabled = true; calculateCombatPower(); return; }
          // 같은 이름이 또 선택되어 있나?
          const chosen = skillSelects
            .filter(s => s !== select)
            .map(s => s.value.split('|')[1]);
          if (chosen.includes(name)){
            alert('동일한 스킬을 중복으로 선택할 수 없습니다!');
            select.value = 'none|해제';
            input.disabled = true;
            select.focus();
          } else {
            input.disabled = false;
          }
          calculateCombatPower();
        };

        select.addEventListener('change', handleChange);
        input.addEventListener('input', () => calculateCombatPower());

        row.appendChild(label); row.appendChild(select); row.appendChild(input);
        parentCol.appendChild(row);

        skillSelects.push(select);
        skillLevelInputs.push({ input, select });
      };

      mkRow(i+1, skillColumn1);
      mkRow(i+5, skillColumn2);
    }

    // ===== 계산 =====
    async function calculateCombatPower(save=false){
      try{
        let combatPower = 0;

        // 축복 효과 집계
        const statAdjust = {};
        blessings.forEach((b, idx) => {
          const btn = blessingButtons[idx];
          if (btn.dataset.state === 'on'){
            if (b.combatPower) combatPower += b.combatPower;
            for (const [k,v] of Object.entries(b.effects)){
              statAdjust[k] = (statAdjust[k]||0) + v;
            }
          }
        });

        // 스탯 계산 (축복 수치 제외)
        stats.forEach((st, idx) => {
          let value = parseFloat(statInputs[idx].value);
          if (Number.isNaN(value) || value < 0){
            statInputs[idx].value = '0';
            value = 0; // 로컬 값도 0으로!
          }
          const adj = statAdjust[st.name] || 0;
          value = Math.max(0, value - adj);
          combatPower += value * st.weight;
        });

        // 스킬 계산
        skillLevelInputs.forEach((sk) => {
          const levelRaw = parseInt(sk.input.value, 10);
          const level = Number.isNaN(levelRaw) ? 1 : Math.min(20, Math.max(1, levelRaw));
          if (Number.isNaN(levelRaw)) sk.input.value = '1';

          // 비활성/해제는 스킵
          const type = sk.type || (sk.select ? sk.select.value.split('|')[0] : 'none');
          if (type === 'none' || sk.input.disabled) return;

          combatPower += (skillValues[type] || skillValues.none)[level - 1];
        });

        // 출력
        resultEl.textContent = `전투력: ${combatPower.toFixed(1)}`;
        resultEl.style.animation='none'; setTimeout(()=>{ resultEl.style.animation='fadeIn .5s ease-in'; },10);

        // 저장 (선택적)
        if (save && window.electronAPI?.saveData){
          const data = {
            stats: statInputs.map(i => i.value),
            skills: skillLevelInputs.map(sk => ({
              type: sk.type || (sk.select ? sk.select.value.split('|')[0] : 'none'),
              name: sk.name || (sk.select ? sk.select.value.split('|')[1] : '해제'),
              level: sk.input.value,
              disabled: sk.input.disabled
            })),
            blessings: blessingButtons.map(b => b.dataset.state)
          };
          await window.electronAPI.saveData(data);
        }
      }catch(err){
        alert(err?.message || '알 수 없는 오류');
      }
    }

    // ===== 리셋 =====
    async function resetInputs(){
      // 기본값 세팅
      statInputs.forEach((input, idx) => {
        input.value = (idx===0) ? '4' : (idx===16) ? '4' : (idx===31) ? '600' : '0';
      });
      skillLevelInputs.forEach((sk) => {
        sk.input.value = '1';
        if (!sk.type){ // 선택형
          sk.select.value = 'none|해제';
          sk.input.disabled = true; // <- 버그 수정: input -> sk.input
        }
      });
      blessingButtons.forEach((btn) => {
        btn.dataset.state = 'off';
        btn.setAttribute('aria-pressed','false');
        // 파일명은 항상 type 기준으로
        const type = btn.dataset.type;
        btn.querySelector('img').src = `images/${type}_off.png`;
      });
      await calculateCombatPower(true);
    }

    // ===== 로드 =====
    async function loadData(){
      try{
        const data = await window.electronAPI?.loadData?.();
        if (data){
          statInputs.forEach((input, idx) => { input.value = data.stats?.[idx] ?? '0'; });

          skillLevelInputs.forEach((sk, idx) => {
            const saved = data.skills?.[idx];
            if (!saved) return;
            if (sk.type){ // 고정형
              sk.input.value = saved.level ?? '1';
            } else {     // 선택형
              sk.select.value = `${saved.type}|${saved.name}`;
              sk.input.value = saved.level ?? '1';
              sk.input.disabled = !!saved.disabled;
            }
          });

          blessingButtons.forEach((btn, idx) => {
            const state = data.blessings?.[idx] ?? 'off';
            btn.dataset.state = state;
            btn.setAttribute('aria-pressed', state === 'on' ? 'true':'false');
            btn.querySelector('img').src = `images/${btn.dataset.type}_${state}.png`;
          });
        } else {
          // 초기 기본값
          statInputs[0].value = '4';
          statInputs[16].value = '4';
          statInputs[31].value = '600';
          skillLevelInputs[0].input.value = '1';
          skillLevelInputs[1].input.value = '1';
        }
        await calculateCombatPower();
      }catch{
        // 저장 시스템이 없을 수도 있으니 조용히 기본값 적용
        statInputs[0].value = '4';
        statInputs[16].value = '4';
        statInputs[31].value = '600';
        skillLevelInputs[0].input.value = '1';
        skillLevelInputs[1].input.value = '1';
        await calculateCombatPower();
      }
    }

    // ===== 이벤트 바인딩 (인라인 제거) =====
    btnCalc.addEventListener('click', () => calculateCombatPower(true));
    btnReset.addEventListener('click', resetInputs);

    // 초기 로드
    loadData();
  </script>
</body>
</html>
